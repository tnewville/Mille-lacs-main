<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Mille Lacs Smallmouth v1.2 (Time/Weather + Fix)</title>
<style>
  :root { --ui:#e7f1ff; --accent:#5fd27a; --gold:#ffd95d; }
  html,body{height:100%;margin:0;background:#07131d;color:var(--ui);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";}
  .wrap{display:flex;flex-direction:column;align-items:center;gap:10px;padding:12px;}
  canvas{border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.45);touch-action:none;background:#0b2a42;}
  .hud{width:min(1000px,96vw);display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:8px;font-weight:650}
  .pill{background:rgba(255,255,255,.08);padding:6px 10px;border-radius:999px}
  .score{color:var(--gold)}
  .btnbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  button{background:rgba(255,255,255,.08);color:var(--ui);border:1px solid rgba(255,255,255,.18);
    padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer;backdrop-filter:saturate(130%) blur(4px)}
  button:active{transform:translateY(1px)}
  .help{opacity:.85;font-size:13px}
  .bar{position:relative;height:14px;width:200px;background:rgba(255,255,255,.08);border-radius:8px;overflow:hidden}
  .bar .zone{position:absolute;top:0;bottom:0;left:32%;right:50%;background:var(--accent);opacity:.35}
  .bar .fill{position:absolute;top:0;bottom:0;left:0;width:0%;background:var(--ui)}
  .bar .needle{position:absolute;top:-3px;width:3px;height:20px;background:var(--ui)}

  /* BIG mobile reel */
  #reelBtnBig{
    display:none; position:fixed; left:50%; transform:translateX(-50%);
    bottom:10px; width:min(680px,96vw); height:68px; font-size:22px; letter-spacing:.5px; z-index:20;
  }
  @media (max-width: 900px){
    #reelBtnBig{ display:block; }
    #reelBtn{ display:none; }
  }

  /* Modals */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45)}
  .card{width:min(820px,94vw);max-height:80vh;overflow:auto;background:#0f1b28;border:1px solid rgba(255,255,255,.2);
    border-radius:12px;padding:14px 16px;box-shadow:0 20px 50px rgba(0,0,0,.6)}
  .row{display:flex;justify-content:space-between;align-items:center;gap:8px}
  .close{cursor:pointer;border:1px solid rgba(255,255,255,.2);padding:6px 10px;border-radius:8px;background:rgba(255,255,255,.06)}
  .list{margin-top:10px;display:grid;gap:8px}
  .item{background:rgba(255,255,255,.05);padding:10px;border-radius:10px}
  .muted{opacity:.8}

  /* Main menu overlay */
  .menu{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:50}
  .menu .panel{background:#0f1b28;border:1px solid rgba(255,255,255,.2);border-radius:14px;padding:18px 22px;
    width:min(640px,92vw);box-shadow:0 30px 80px rgba(0,0,0,.6);text-align:center}
  .menu h1{margin:6px 0 4px 0;font-size:28px}
  .menu .ver{opacity:.85;font-weight:700;margin-bottom:10px}
  .menu .btnrow{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:10px}
  .dbg{position:fixed;right:8px;bottom:80px;font-size:12px;opacity:.7}
  .hint{position:fixed;right:8px;bottom:8px;background:rgba(0,0,0,.5);padding:6px 10px;border-radius:8px;font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <div class="hud">
    <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
      <div class="pill">üìç Mille Lacs Lake ‚Äî ~1 mile offshore</div>
      <div class="pill">‚òÄÔ∏è <span id="timeLabel">Sunrise</span><span id="weatherLabel" class="pill" style="margin-left:8px;background:rgba(255,255,255,.06)">Clear</span></div>
      <div class="pill">üé£ <span id="msg">Tap/Space to cast</span></div>
    </div>
    <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
      <div class="pill">Score: <span class="score" id="score">0</span></div>
      <div class="pill">Lives: <span id="lives">3</span></div>
      <div class="pill">Day: <span id="day">1</span></div>
      <div class="pill">Bag: <span id="bagLabel">0 lb 0 oz (0/5)</span></div>
      <div class="pill" title="Game version">v<span id="versionLabel">1.2</span></div>
      <div class="help">Tension</div>
      <div class="bar" id="tensionBar"><div class="zone"></div><div class="needle" id="needle"></div></div>
      <div class="help">Catch</div>
      <div class="bar" id="catchBar"><div class="fill" id="catchFill"></div></div>
      <div class="btnbar">
        <button id="castBtn">Cast</button>
        <button id="reelBtn">Reel</button>
        <button id="toggleViewBtn" title="Toggle underwater view">Underwater</button>
        <button id="pauseBtn">Pause</button>
        <button id="archiveBtn">Archive</button>
        <button id="trophiesBtn">Trophy Room</button>
      </div>
    </div>
  </div>

  <canvas id="game" width="1000" height="562" aria-label="Mille Lacs Smallmouth game" style="width:min(1000px,96vw);height:calc(min(1000px,96vw)/1.7777)"></canvas>
  <div class="help">Controls: Space/Click = Cast ‚Ä¢ Hold Reel to bring fish in ‚Ä¢ Line never breaks in this mode ‚Ä¢ Toggle Underwater to watch fish.</div>
</div>

<button id="reelBtnBig">üé£ REEL ‚Äî HOLD</button>
<div class="dbg" id="dbg"></div>
<div class="hint" id="depthHint" style="display:none;">Hot depth: ‚Äî</div>

<!-- Archive modal -->
<div id="modalArchive" class="modal" role="dialog" aria-modal="true" aria-labelledby="archTitle">
  <div class="card">
    <div class="row">
      <h3 id="archTitle" style="margin:4px 0;">üìí Archived Bags</h3>
      <button class="close" data-close="#modalArchive">Close</button>
    </div>
    <div id="archList" class="list"></div>
    <div class="muted" style="margin-top:8px;font-size:13px;">Your top 5 for each completed day.</div>
  </div>
</div>

<!-- Trophy modal -->
<div id="modalTrophies" class="modal" role="dialog" aria-modal="true" aria-labelledby="trophyTitle">
  <div class="card">
    <div class="row">
      <h3 id="trophyTitle" style="margin:4px 0;">üèÜ Trophy Room</h3>
      <button class="close" data-close="#modalTrophies">Close</button>
    </div>
    <div id="trophyList" class="list"></div>
    <div class="muted" style="margin-top:8px;font-size:13px;">All-time heaviest smallmouth you‚Äôve landed.</div>
  </div>
</div>

<!-- Main menu -->
<div id="mainMenu" class="menu" aria-modal="true" role="dialog">
  <div class="panel">
    <h1>Mille Lacs Smallmouth</h1>
    <div class="ver">Version <strong>v<span id="menuVersion">1.2</span></strong></div>
    <div style="opacity:.9;margin:6px 0 12px 0;">Smallmouth-only ‚Ä¢ Daily Top-5 Bag ‚Ä¢ Trophy Room ‚Ä¢ Underwater View ‚Ä¢ Time+Weather-aware bite</div>
    <div class="btnrow">
      <button id="startBtn">Start Day</button>
      <button id="openArchive">Archive</button>
      <button id="openTrophies">Trophy Room</button>
      <button id="toggleDepthHint">Show Hot Depth</button>
    </div>
    <div class="muted" style="margin-top:10px;font-size:12px;">Tip: On phones, use the big REEL button at the bottom.</div>
  </div>
</div>

<script>
(() => {
  const VERSION = '1.2';

  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d'); // most compatible
  let dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
  function applyScale(){ ctx.setTransform(dpr,0,0,dpr,0,0); }
  applyScale(); window.addEventListener('resize', applyScale);

  // UI
  document.getElementById('versionLabel').textContent = VERSION;
  document.getElementById('menuVersion').textContent = VERSION;

  const dbg = document.getElementById('dbg');
  const depthHint = document.getElementById('depthHint');
  const msgEl = document.getElementById('msg');
  const scoreEl = document.getElementById('score');
  const livesEl = document.getElementById('lives');
  const dayEl = document.getElementById('day');
  const bagLabel = document.getElementById('bagLabel');
  const timeLabel = document.getElementById('timeLabel');
  const weatherLabel = document.getElementById('weatherLabel');
  const castBtn = document.getElementById('castBtn');
  const reelBtn = document.getElementById('reelBtn');
  const reelBtnBig = document.getElementById('reelBtnBig');
  const pauseBtn = document.getElementById('pauseBtn');
  const toggleViewBtn = document.getElementById('toggleViewBtn');
  const toggleDepthHintBtn = document.getElementById('toggleDepthHint');
  const archiveBtn = document.getElementById('archiveBtn');
  const trophiesBtn = document.getElementById('trophiesBtn');
  const needle = document.getElementById('needle');
  const catchFill = document.getElementById('catchFill');
  const modalArchive = document.getElementById('modalArchive');
  const modalTrophies = document.getElementById('modalTrophies');
  const archList = document.getElementById('archList');
  const trophyList = document.getElementById('trophyList');
  const mainMenu = document.getElementById('mainMenu');
  const startBtn = document.getElementById('startBtn');
  const openArchive = document.getElementById('openArchive');
  const openTrophies = document.getElementById('openTrophies');

  const W = () => canvas.clientWidth || canvas.width;
  const H = () => canvas.clientHeight || canvas.height;
  const rng = (a,b)=>a + Math.random()*(b-a);
  const clamp = (x,a,b)=>Math.max(a,Math.min(b,x));
  const sum = arr => arr.reduce((s,v)=>s+v,0);
  function lineLength(ax,ay,bx,by){ const dx=bx-ax,dy=by-ay; return Math.hypot(dx,dy); }

  // State
  let running=true, tick=0;
  let score=0, lives=3, day=1;
  let underwater=false;

  // Time of day & weather
  let timeOfDay = 0.0; // 0..1 ‚Äî sunrise to sunset
  const timeSpeed = 0.0008; // adjust for longer/shorter days
  const weathers = ['Clear','Cloudy','Mist'];
  let weather = weathers[Math.floor(Math.random()*weathers.length)];
  function timeOfDayLabel(t){
    if (t < 0.33) return 'Sunrise';
    if (t < 0.66) return 'Midday';
    return 'Evening';
  }
  function windLabelFromWeather(w){ // derive a simple calm/windy from our existing weather model
    const windMag = (w==='Clear'?0.1:(w==='Cloudy'?0.18:0.22));
    return windMag < 0.15 ? 'calm' : 'windy';
  }

  // Bite schedule
  function getBiteChance(t, w, windLabel){
    let base = 0.30;
    // Time windows (approx mapping across 0..1 day)
    if (t < 0.33) base *= 1.40;       // sunrise‚Äì~8am
    else if (t < 0.45) base *= 1.10;  // 8‚Äì11am
    else if (t < 0.54) base *= 0.70;  // 12‚Äì1pm lull
    else if (t < 0.66) base *= 1.10;  // 1‚Äì4pm
    else base *= 1.25;                // 5pm‚Äìsunset (2nd best)
    return base;
  }

  // Depth preferences (feet)
  function getTargetDepthRange(weather, windLabel){
    const sunny = (weather==='Clear');
    const cloudy = (weather==='Cloudy' || weather==='Mist');
    if (sunny && windLabel==='calm') return [8,14];
    if (sunny && windLabel==='windy') return [14,18];
    if (cloudy && windLabel==='calm') return [16,20];
    if (cloudy && windLabel==='windy') return [20,28];
    return [12,18];
  }
  const surfaceY = () => H()*0.18;
  const bottomY = () => H()*0.98;
  const waterHeight = () => H()*0.82;
  function depthFtToY(ft){
    const maxFt = 30;
    const frac = clamp(ft/maxFt, 0, 1);
    return surfaceY() + frac*waterHeight();
  }

  // Bag + archive + trophies
  let bag = []; // top 5 oz
  const archive = []; // {day,totalOz,weightsOz:[]}
  const trophies = []; // {oz, day, id}

  function ozToLbOz(oz){ const lb=Math.floor(oz/16); return {lb,oz:oz-lb*16}; }
  function bagLabelText(){
    const total = sum(bag.slice(0,5));
    const t = ozToLbOz(total);
    return `${t.lb} lb ${t.oz} oz (${bag.length}/5)`;
  }
  function updateBagUI(){ bagLabel.textContent = bagLabelText(); }
  function addToBag(oz){
    bag.push(oz); bag.sort((a,b)=>b-a); if (bag.length>5) bag.length=5; updateBagUI();
  }
  function archiveDay(){
    archive.push({ day, totalOz: sum(bag), weightsOz: [...bag] });
    bag = []; updateBagUI(); renderArchive();
  }
  function renderArchive(){
    archList.innerHTML='';
    if (archive.length===0){
      archList.innerHTML='<div class="item">No archived bags yet. Finish a day to see it here.</div>'; return;
    }
    for (const entry of archive){
      const t = ozToLbOz(entry.totalOz);
      const items = entry.weightsOz.map((oz,i)=>{
        const w = ozToLbOz(oz); return `#${i+1}: ${w.lb} lb ${w.oz} oz`;
      }).join(' ‚Ä¢ ');
      const div = document.createElement('div');
      div.className='item';
      div.textContent=`Day ${entry.day} ‚Äî Total: ${t.lb} lb ${t.oz} oz ‚Äî ${items}`;
      archList.appendChild(div);
    }
  }
  function addTrophy(oz){
    const id = Date.now()+Math.random();
    trophies.push({oz, day, id});
    trophies.sort((a,b)=>b.oz - a.oz);
    if (trophies.length>20) trophies.length=20;
    renderTrophies();
  }
  function renderTrophies(){
    trophyList.innerHTML='';
    if (trophies.length===0){
      trophyList.innerHTML='<div class="item">No trophies yet. Land a giant!</div>'; return;
    }
    trophies.forEach((t,idx)=>{
      const w = ozToLbOz(t.oz);
      const div=document.createElement('div');
      div.className='item';
      div.textContent = `#${idx+1}: ${w.lb} lb ${w.oz} oz ‚Äî Day ${t.day}`;
      trophyList.appendChild(div);
    });
  }

  // Boat & bobber
  const horizonY = 0.18;
  const boat = { x: W()*0.22, y: H()*(horizonY+0.10), bob:0 };
  const player = {
    x: boat.x + 52, y: boat.y - 2,
    bobber: { x: boat.x + 52, y: boat.y - 2, vx:0, vy:0, casted:false, hooked:false, splash:0 }
  };

  // Fish
  const fish = [];
  function spawnSmallmouth(n=7){
    const [ftMin, ftMax] = getTargetDepthRange(weather, windLabelFromWeather(weather));
    const yCenter = (depthFtToY(ftMin) + depthFtToY(ftMax))/2;
    const ySpread = Math.abs(depthFtToY(ftMax) - depthFtToY(ftMin))*0.6;
    for (let i=0;i<n;i++){
      const y = clamp( rng(yCenter - ySpread, yCenter + ySpread), surfaceY()+H()*0.04, bottomY()-H()*0.04 );
      const dir = Math.random()<0.5 ? -1 : 1;
      const x = rng(W()*0.08, W()*0.92);
      fish.push({x,y,dir,t:rng(0,Math.PI*2),wobble:rng(0.5,1.0),vx:dir*rng(0.35,0.7)*1.25,biteCooldown:0,near:false});
    }
  }
  spawnSmallmouth(10);

  // Mini-game (mobile-easy: no line breaks)
  let hasBite=false, reeling=false, tension=0.22, catchProg=0;
  const greenMin=0.32, greenMax=0.50;
  const BITE_RADIUS = 34;      // within this distance a fish is "interested"
  const targetTension = 0.41;  // center of green

  // Weight distribution (oz)
  function rngInt(a,b){ return Math.floor(a + Math.random()*(b-a+1)); }
  function randomWeightOz(){
    const r = Math.random()*100;
    if (r < 50) return rngInt(60,72);        // 3lb12oz‚Äì4lb8oz
    else if (r < 64) return rngInt(48,59);   // 3lb0oz‚Äì3lb11oz
    else if (r < 79) return rngInt(73,84);   // 4lb9oz‚Äì5lb4oz
    else if (r < 91) return rngInt(85,95);   // 5lb5oz‚Äì5lb15oz
    else if (r < 98) return rngInt(96,109);  // 6lb0oz‚Äì6lb13oz
    else return rngInt(110,116);             // 6lb14oz‚Äì7lb4oz
  }
  function weightToPoints(oz){ return Math.max(10, Math.round(20 + (oz - 48) * 2)); }
  function setMessage(t){ msgEl.textContent = t; }

  function cast(){
    if (!running) return;
    const b = player.bobber;
    if (b.casted || hasBite) return;
    b.casted = true; b.hooked = false; catchProg = 0; tension = 0.22;

    const angle = -Math.PI/6, speed = 7.2;
    b.vx = Math.cos(angle)*speed; b.vy = Math.sin(angle)*speed; b.splash = 12;
    setMessage('Mille Lacs ‚Äî waiting for a bite...');
  }
  function startReel(){ if (!running) return; reeling = true; }
  function stopReel(){ reeling = false; }

  // Inputs
  castBtn.addEventListener('click', cast, { passive: true });
  reelBtn.addEventListener('pointerdown', startReel);
  reelBtn.addEventListener('pointerup', stopReel);
  reelBtn.addEventListener('pointerleave', stopReel);
  reelBtnBig.addEventListener('pointerdown', startReel);
  reelBtnBig.addEventListener('pointerup', stopReel);
  reelBtnBig.addEventListener('pointerleave', stopReel);
  pauseBtn.addEventListener('click', ()=>{ running=!running; pauseBtn.textContent=running?'Pause':'Resume'; if(running) animate(); });
  toggleViewBtn.addEventListener('click', ()=>{ underwater=!underwater; toggleViewBtn.textContent = underwater ? 'Surface' : 'Underwater'; });
  toggleDepthHintBtn.addEventListener('click', ()=>{
    depthHint.style.display = depthHint.style.display==='none' ? 'block' : 'none';
  });
  archiveBtn.addEventListener('click', ()=>{ renderArchive(); modalArchive.style.display='flex'; });
  trophiesBtn.addEventListener('click', ()=>{ renderTrophies(); modalTrophies.style.display='flex'; });
  document.querySelectorAll('.close').forEach(btn=>btn.addEventListener('click', (e)=>{
    const sel = e.target.getAttribute('data-close'); if (sel) document.querySelector(sel).style.display='none';
  }));
  [modalArchive, modalTrophies].forEach(m => m.addEventListener('click', (e)=>{ if (e.target===m) m.style.display='none'; }));

  window.addEventListener('keydown', e=>{
    if (e.code==='Space'){ if (!player.bobber.casted && !hasBite) cast(); startReel(); }
    if (e.key==='Escape'){ modalArchive.style.display='none'; modalTrophies.style.display='none'; }
  }, { passive: true });
  window.addEventListener('keyup', e=>{ if (e.code==='Space') stopReel(); }, { passive: true });
  canvas.addEventListener('pointerdown', e=>{ if (!player.bobber.casted && !hasBite) cast(); startReel(); });
  canvas.addEventListener('pointerup', stopReel);
  canvas.addEventListener('pointerleave', stopReel);

  // Main menu buttons
  startBtn.addEventListener('click', ()=>{ mainMenu.style.display='none'; setMessage('Tap/Space to cast'); });

  function updateHUD(){ scoreEl.textContent=score; livesEl.textContent=lives; dayEl.textContent=day; updateBagUI(); }

  function updateTimeAndWeather(){
    timeOfDay += timeSpeed; if (timeOfDay > 1) timeOfDay = 0;
    const windMag = weather==='Clear' ? 0.1 : weather==='Cloudy' ? 0.18 : 0.22;
    boat.x += Math.sin(tick*0.003)*windMag;
    boat.bob = Math.sin(tick*0.02)*(weather==='Clear'?3:weather==='Cloudy'?3.5:4);
    if (Math.abs(timeOfDay-0.99)<0.001 && Math.random()<0.15){
      weather = weathers[Math.floor(Math.random()*weathers.length)];
    }
    timeLabel.textContent = timeOfDayLabel(timeOfDay);
    weatherLabel.textContent = weather;
    const [dmin,dmax] = getTargetDepthRange(weather, windLabelFromWeather(weather));
    depthHint.textContent = `Hot depth: ${dmin}-${dmax} ft`;
  }

  function updateBobber(){
    const b = player.bobber;
    player.x = boat.x + 52;
    player.y = boat.y - 2 + boat.bob;

    if (b.casted){
      b.vy += 0.22; b.vx *= 0.995; b.vy *= 0.995;
      b.x += b.vx; b.y += b.vy;

      if (b.y < H()*0.18 + 6){ b.y = H()*0.18 + 6; b.vy *= -0.2; }
      if (b.y > H()*0.97){ b.y = H()*0.97; b.vy *= -0.2; }
      if (b.x < 8){ b.x = 8; b.vx *= -0.2; }
      if (b.x > W()-8){ b.x = W()-8; b.vx *= -0.2; }

      if (reeling){
        const ang = Math.atan2(b.y - player.y, b.x - player.x);
        b.vx -= Math.cos(ang)*0.44; b.vy -= Math.sin(ang)*0.44;
      }

      // Bite check: time+weather aware
      if (!hasBite){
        const windLabel = windLabelFromWeather(weather);
        const chance = getBiteChance(timeOfDay, weather, windLabel);
        for (const f of fish){
          if (f.biteCooldown>0) { continue; }
          const d = lineLength(b.x,b.y,f.x,f.y);
          if (d < BITE_RADIUS){
            if (!f.near){
              f.near = true; // just entered interest zone
              if (Math.random() < chance){
                hasBite = true; b.hooked = true; f.biteCooldown = rng(200,300);
                setMessage('Hooked! Hold REEL to bring it in!');
                break;
              } else {
                f.biteCooldown = rng(80,160); // not this time
              }
            }
          } else {
            if (f.near) f.near = false;
          }
        }
      }

      // Mini-game (no line break mode)
      if (b.hooked){
        const drift = Math.sin(tick*0.08) * 0.004;
        if (reeling){
          tension += (0.41 - tension)*0.18 + drift;
        } else {
          tension += (-0.006) + drift;
        }
        tension = clamp(tension, 0.0, 1.0);

        const inGreen = (tension>=0.32 && tension<=0.50);
        if (reeling){
          catchProg += inGreen ? 0.010 : 0.006;
        } else {
          catchProg += inGreen ? 0.004 : -0.004;
        }
        catchProg = clamp(catchProg,0,1);
        if (catchProg>=1) landFish();

        needle.style.left = (tension*100)+'%';
        catchFill.style.width = (catchProg*100)+'%';
      } else {
        tension = tension*0.95 + 0.05*0.22;
        needle.style.left = (tension*100)+'%';
        catchFill.style.width = '0%';
      }

      if (b.splash>0) b.splash--;
    } else {
      b.x += (player.x - b.x)*0.25; b.y += (player.y - b.y)*0.25;
      b.vx *= 0.85; b.vy *= 0.85;
    }
  }

  function drawBackground(){
    const t = timeOfDay;
    const skyTop = t<0.5 ? lerpColor([0x9b,0xd2,0xff],[0x6f,0xb8,0xff], t/0.5)
                         : lerpColor([0x6f,0xb8,0xff],[0xff,0xc9,0x8a], (t-0.5)/0.5);
    const skyBot = t<0.5 ? lerpColor([0xe6,0xf3,0xff],[0xb6,0xd8,0xf5], t/0.5)
                         : lerpColor([0xb6,0xd8,0xf5],[0xff,0xe3,0xb0], (t-0.5)/0.5);
    let haze = 0; if (weather==='Cloudy') haze=0.18; if (weather==='Mist') haze=0.28;
    const top = rgb(dim(skyTop,haze)), bot = rgb(dim(skyBot,haze));
    const skyGrad = ctx.createLinearGradient(0,0,0,H()*0.18);
    skyGrad.addColorStop(0, top); skyGrad.addColorStop(1, bot);
    ctx.fillStyle = skyGrad; ctx.fillRect(0,0,W(),H()*0.18);

    const y = H()*0.18;
    const shore = weather==='Mist' ? 'rgba(220,235,250,0.4)' : 'rgba(207,230,251,0.6)';
    ctx.fillStyle = shore; ctx.fillRect(0,y-2,W(),4);
    ctx.fillStyle = weather==='Mist' ? 'rgba(190,215,240,0.5)' : 'rgba(182,216,245,1)';
    for (let i=0;i<24;i++){
      const x = (i/24)*W(), h = 6+Math.random()*6;
      ctx.beginPath(); ctx.moveTo(x,y); ctx.lineTo(x+8,y); ctx.lineTo(x+4,y-h); ctx.closePath(); ctx.fill();
    }

    // Water
    const base = [0x0f,0x36,0x52], evening=[0x0b,0x2a,0x42];
    const wc = t<0.5 ? base : [Math.round(base[0] + (evening[0]-base[0])*(t-0.5)/0.5),
                               Math.round(base[1] + (evening[1]-base[1])*(t-0.5)/0.5),
                               Math.round(base[2] + (evening[2]-base[2])*(t-0.5)/0.5)];
    const wcol = hazy(wc, weather);
    ctx.fillStyle = wcol; ctx.fillRect(0,H()*0.18,W(),H()*0.82);

    const basey = H()*0.18; const waves = weather==='Cloudy'?14:weather==='Mist'?12:18;
    for (let i=0;i<waves;i++){
      const yy = basey + i*14 + Math.sin((tick*0.02)+(i*0.6))*2;
      ctx.globalAlpha = 0.05 + (i%2)*0.02; ctx.fillStyle = 'rgba(174,225,255,1)'; ctx.fillRect(0,yy,W(),2);
    }
    ctx.globalAlpha = 1;
  }
  function hazy(c, w){const amt=w==='Mist'?0.1:w==='Cloudy'?0.06:0; return `rgb(${Math.round(c[0]*(1-amt))},${Math.round(c[1]*(1-amt))},${Math.round(c[2]*(1-amt))})`; }
  function rgb(c){ return `rgb(${c[0]},${c[1]},${c[2]})`; }
  function lerp(a,b,t){ return a+(b-a)*t; }
  function lerpColor(a,b,t){ return [Math.round(lerp(a[0],b[0],t)), Math.round(lerp(a[1],b[1],t)), Math.round(lerp(a[2],b[2],t))]; }

  function drawBoat(){
    const y = boat.y + boat.bob, x = boat.x;
    ctx.fillStyle = '#324966';
    ctx.beginPath(); ctx.moveTo(x-70,y); ctx.lineTo(x+90,y);
    ctx.quadraticCurveTo(x+70,y+18,x-50,y+18); ctx.closePath(); ctx.fill();

    ctx.fillStyle = '#e7f1ff';
    ctx.beginPath(); ctx.arc(player.x, player.y-12, 6, 0, Math.PI*2); ctx.fill();
    ctx.fillRect(player.x-3, player.y-12, 6, 22);

    ctx.strokeStyle = '#e7f1ff'; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.moveTo(player.x+6, player.y-12);
    ctx.quadraticCurveTo(player.x+42, player.y-42, player.x+96, player.y-20); ctx.stroke();
  }

  function drawLineAndBobber(){
    const b = player.bobber;
    ctx.strokeStyle = 'rgba(220,240,255,0.9)'; ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(player.x+96, player.y-20); ctx.lineTo(b.x,b.y); ctx.stroke();

    ctx.fillStyle = '#ff5858'; ctx.beginPath(); ctx.arc(b.x,b.y,6,0,Math.PI*2); ctx.fill();
    ctx.fillStyle = '#ffffff'; ctx.beginPath(); ctx.arc(b.x,b.y-3,3,0,Math.PI*2); ctx.fill();

    if (b.splash>0){
      ctx.strokeStyle = 'rgba(255,255,255,'+(b.splash/12).toFixed(2)+')';
      ctx.beginPath(); ctx.arc(b.x,b.y,10+(12-b.splash)*2,0,Math.PI*2); ctx.stroke();
    }
  }

  function drawUnderwater(){
    const gr = ctx.createLinearGradient(0,H()*0.18,0,H());
    gr.addColorStop(0, 'rgba(11,42,66,0.95)');
    gr.addColorStop(1, 'rgba(6,24,40,1)');
    ctx.fillStyle = gr; ctx.fillRect(0,H()*0.18,W(),H()*0.82);

    const b = player.bobber;
    ctx.fillStyle = 'rgba(255,255,255,0.08)';
    ctx.beginPath(); ctx.ellipse(b.x, b.y+8, 12, 6, 0, 0, Math.PI*2); ctx.fill();

    drawFish(true);
  }

  function drawFish(under=false){
    for (const f of fish){
      ctx.save(); ctx.translate(f.x,f.y); ctx.scale(f.dir,1);
      const s = under ? 26 : 20;
      ctx.fillStyle = '#8be68b';
      ctx.beginPath(); ctx.ellipse(0,0,s*0.7,s*0.37,0,0,Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.moveTo(-s*0.7,0); ctx.lineTo(-s*0.95,-s*0.16); ctx.lineTo(-s*0.95,s*0.16); ctx.closePath(); ctx.fill();
      ctx.fillStyle = '#05201a'; ctx.beginPath(); ctx.arc(s*0.35,-s*0.08,s*0.06,0,Math.PI*2); ctx.fill();
      ctx.restore();
    }
  }

  function drawOverlay(){
    if (hasBite){
      ctx.fillStyle = 'rgba(0,0,0,0.22)'; ctx.fillRect(W()*0.28,8,W()*0.44,28);
      ctx.fillStyle = '#e7f1ff'; ctx.font = 'bold 16px system-ui'; ctx.textAlign = 'center';
      ctx.fillText('Bite! Hold the REEL button.', W()*0.5, 28);
    }
    timeLabel.textContent = timeOfDayLabel(timeOfDay);
    weatherLabel.textContent = weather;
  }

  function updateFish(){
    const b = player.bobber;
    for (const f of fish){
      f.t += 0.03 * 1.15;
      f.x += f.vx + Math.cos(f.t)*0.3*f.wobble;
      f.y += Math.sin(f.t*0.7)*0.6*f.wobble;

      if (f.biteCooldown>0) f.biteCooldown--;

      const d = lineLength(b.x,b.y,f.x,f.y);
      if (player.bobber.splash>0 && d<120){
        const ang = Math.atan2(f.y - b.y, f.x - b.x);
        f.x += Math.cos(ang)*2.6; f.y += Math.sin(ang)*2.6;
      } else if (!hasBite && b.casted && d<120){
        if (Math.random()<0.04){
          const ang = Math.atan2(b.y - f.y, b.x - f.x);
          f.x += Math.cos(ang)*1.2; f.y += Math.sin(ang)*1.2;
        }
      }

      if (f.x < 12){ f.x=12; f.vx=Math.abs(f.vx); f.dir=1; }
      if (f.x > W()-12){ f.x=W()-12; f.vx=-Math.abs(f.vx); f.dir=-1; }
      if (f.y < H()*0.22) f.y = H()*0.22;
      if (f.y > H()*0.96) f.y = H()*0.96;
    }
    // Maintain school count with current depth preference
    if (fish.length<10) spawnSmallmouth(3);
  }

  function landFish(){
    hasBite=false; player.bobber.hooked=false; player.bobber.casted=false;
    const oz = randomWeightOz();
    const pts = weightToPoints(oz);
    score += pts;
    addToBag(oz);
    addTrophy(oz);
    const w = ozToLbOz(oz);
    setMessage(`Caught a Smallmouth Bass (${w.lb} lb ${w.oz} oz)! +${pts} pts ‚Äî Added to bag & trophies!`);
    updateHUD(); catchProg=0; tension=0.22;
  }

  // --- Render loop with rAF fallback + immediate draw ---
  function drawOnce(){
    ctx.clearRect(0,0,W(),H());
    drawBackground();
    if (!underwater){ drawFish(false); drawBoat(); drawLineAndBobber(); }
    else { drawBoat(); drawUnderwater(); drawLineAndBobber(); }
    drawOverlay();
    if (dbg) dbg.textContent = 'tick '+tick;
  }

  let useRAF = true;
  function animate(){
    if (!running) return;
    tick++;
    updateTimeAndWeather();
    updateBobber();
    updateFish();
    drawOnce();
    if (useRAF) requestAnimationFrame(animate); else setTimeout(animate, 16);
  }

  // rAF watchdog: if first frame didn't happen within 1s, switch to setTimeout loop
  setTimeout(()=>{ if (tick===0){ useRAF=false; animate(); } }, 1000);

  function setInitialPositions(){
    boat.x = W()*0.22; boat.y = H()*(horizonY+0.10);
    player.bobber.x = boat.x + 52; player.bobber.y = boat.y - 2;
  }
  setInitialPositions(); updateHUD(); setMessage('Tap/Space to cast');
  drawOnce(); // immediate first draw so something appears right away
  animate();
  window.addEventListener('resize', ()=>{ setInitialPositions(); drawOnce(); });
})();
</script>
</body>
</html>
